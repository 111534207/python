{% extends 'base.html' %}

{% block title %}ç·¨è¼¯ - {{ movie.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">âœï¸ ç·¨è¼¯é›»å½±ç‹€æ…‹</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        {% if movie.poster_path %}
                            <img src="https://image.tmdb.org/t/p/w200{{ movie.poster_path }}" class="rounded shadow-sm mb-3">
                        {% endif %}
                        <h3>{{ movie.title }}</h3>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">è§€å½±ç‹€æ…‹</label>
                            <select name="status" class="form-select">
                                <option value="plan" {% if movie.status == 'plan' %}selected{% endif %}>æƒ³çœ‹</option>
                                <option value="watching" {% if movie.status == 'watching' %}selected{% endif %}>è§€çœ‹ä¸­</option>
                                <option value="watched" {% if movie.status == 'watched' %}selected{% endif %}>å·²çœ‹å®Œ</option>
                                <option value="dropped" {% if movie.status == 'dropped' %}selected{% endif %}>æ£„åŠ‡</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">è©•åˆ†</label>
                            <div class="input-group">
                                <span class="input-group-text">â­</span>
                                <input type="number" step="0.1" min="0" max="10" name="rating" 
                                       class="form-control" value="{{ movie.rating|default:'' }}" placeholder="å°šæœªè©•åˆ†">
                            </div>
                            <div class="form-text">è«‹è¼¸å…¥ 0 åˆ° 10 ä¹‹é–“çš„æ•¸å­—</div>
                        </div>

                        <div class="mb-3">
                            <label for="reviewInput" class="form-label fw-bold">è§€å½±å¿ƒå¾—</label>
                            
                            <button type="button" class="btn btn-sm btn-outline-warning mb-2 ms-2" onclick="callAI()">
                                âœ¨ AI å¹«æˆ‘å¯«
                            </button>
                            
                            <textarea name="review" id="reviewInput" class="form-control" rows="4" placeholder="å¯«ä¸‹ä½ çš„æƒ³æ³•...">{{ movie.review|default:'' }}</textarea>
                            
                            <input type="hidden" id="movieTitleForAI" value="{{ movie.title }}">
                        </div>

                        <script>
                            function getCookie(name) {
                                let cookieValue = null;
                                if (document.cookie && document.cookie !== '') {
                                    const cookies = document.cookie.split(';');
                                    for (let i = 0; i < cookies.length; i++) {
                                        const cookie = cookies[i].trim();
                                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                            break;
                                        }
                                    }
                                }
                                return cookieValue;
                            }

                            async function callAI() {
                                const btn = document.querySelector('button[onclick="callAI()"]');
                                const textarea = document.getElementById('reviewInput');
                                const title = document.getElementById('movieTitleForAI').value;
                                const ratingInput = document.querySelector('input[name="rating"]'); 
                                const rating = ratingInput ? ratingInput.value : 8;
                                const csrftoken = getCookie('csrftoken'); // ç²å– CSRF Token

                                btn.innerHTML = 'ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...';
                                btn.disabled = true;

                                try {
                                    const response = await fetch('/api/generate-review/', { // ç¢ºä¿ä½ çš„ urls.py æœ‰é€™å€‹è·¯å¾‘
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': csrftoken // åŠ å…¥ Token é¿å… 403 éŒ¯èª¤
                                        },
                                        body: JSON.stringify({
                                            title: title,
                                            rating: rating
                                        })
                                    });

                                    const data = await response.json();

                                    if (data.status === 'success') {
                                        textarea.value = data.review;
                                    } else {
                                        alert('AI ç™¼ç”ŸéŒ¯èª¤ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                                    }
                                } catch (error) {
                                    console.error(error);
                                    alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯è¨­å®š');
                                } finally {
                                    btn.innerHTML = 'âœ¨ AI å¹«æˆ‘å¯«';
                                    btn.disabled = false;
                                }
                            }
                        </script>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-md-2">å–æ¶ˆ</a>
                            <button type="submit" class="btn btn-primary px-4">å„²å­˜è®Šæ›´</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}